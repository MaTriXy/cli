{"version":3,"file":"facebook.strategy.js","sourceRoot":"","sources":["../../../../libs/rucken/auth-nestjs/src/passport/facebook.strategy.ts"],"names":[],"mappings":"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","sourcesContent":["import { Inject, Injectable } from '@nestjs/common';\nimport { plainToClass } from 'class-transformer';\nimport { use } from 'passport';\nimport * as FacebookTokenStrategy from 'passport-facebook-token';\nimport { FACEBOOK_CONFIG_TOKEN } from '../configs/facebook.config';\nimport { SignUpDto } from '../dto/sign-up.dto';\nimport { OauthTokensAccesstoken } from '../entities/oauth-tokens-accesstoken.entity';\nimport { IFacebookConfig } from '../interfaces/facebook-config.interface';\nimport { AuthService } from '../services/auth.service';\nimport { OauthTokensAccesstokensService } from '../services/oauth-tokens-accesstokens.service';\n\n@Injectable()\nexport class FacebookStrategy {\n  constructor(\n    @Inject(FACEBOOK_CONFIG_TOKEN) private readonly fbConfig: IFacebookConfig,\n    private readonly oauthTokensAccesstokensService: OauthTokensAccesstokensService,\n    private readonly authService: AuthService\n  ) {\n    this.init();\n  }\n\n  private init(): void {\n    use(\n      'facebook',\n      new FacebookTokenStrategy(\n        {\n          clientID: this.fbConfig.client_id,\n          clientSecret: this.fbConfig.client_secret\n        },\n        async (accessToken: string, refreshToken: string, profile: any, done) => {\n          // Logger.log(JSON.stringify(profile), FacebookStrategy.name);\n          if (!profile.id) {\n            done(null, null);\n          }\n          try {\n            try {\n              const { oauthTokensAccesstoken } = await this.oauthTokensAccesstokensService.findByProviderClientId({\n                id: profile.id\n              });\n              const { user } = await this.authService.info({\n                id: oauthTokensAccesstoken.user.id\n              });\n              done(null, user);\n            } catch (err) {\n              const email =\n                profile.emails && profile.emails.length && profile.emails[0].value\n                  ? profile.emails[0].value\n                  : `${profile.id}@facebook.com`;\n              const username = `facebook_${profile.id}`;\n              const firstName = profile.name.givenName;\n              const lastName = profile.name.familyName;\n              const password = `facebook_${profile.id}`;\n              const { user } = await this.authService.signUp(\n                plainToClass(SignUpDto, {\n                  email,\n                  username,\n                  password,\n                  firstName,\n                  lastName\n                })\n              );\n              const newOauthTokensAccesstoken = new OauthTokensAccesstoken();\n              newOauthTokensAccesstoken.user = user;\n              newOauthTokensAccesstoken.providerClientId = profile.id;\n              newOauthTokensAccesstoken.provider = profile.provider;\n              newOauthTokensAccesstoken.accessToken = accessToken;\n              await this.oauthTokensAccesstokensService.create({\n                item: newOauthTokensAccesstoken\n              });\n              done(null, user);\n            }\n          } catch (err) {\n            done(err, null);\n          }\n        }\n      )\n    );\n  }\n}\n"]}